<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda - TV</title>

  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js"></script>

  <!-- ical.js para ler .ics -->
  <script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>

  <style>
    :root {
      --zoom: 1.35;                 /* pode ser sobrescrito via ?zoom= */
      --event-color: #3b82f6;       /* pode ser sobrescrito via ?color= */
      --bg: #0b0b0b;
      --bg-alt: #121212;
      --text: #e9e9e9;
      --muted: #b8b8b8;
      --border: #262626;
      --accent: #1a73e8;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); }
    #calendar { height: 100%; max-height: 100vh; }

    /* escala geral para TV */
    body { font-size: calc(16px * var(--zoom)); }

    /* Tema do FullCalendar */
    .fc-theme-standard {
      --fc-page-bg-color: var(--bg);
      --fc-neutral-bg-color: var(--bg-alt);
      --fc-border-color: var(--border);
      --fc-now-indicator-color: var(--accent);
    }
    .fc .fc-toolbar-title { font-weight: 800; letter-spacing: .3px; }
    .fc .fc-timegrid-slot-label-cushion,
    .fc .fc-col-header-cell-cushion { color: var(--muted); font-weight: 600; }
    .fc .fc-timegrid-slot { height: calc(2.4em * var(--zoom)); } /* slots mais altos */
    .fc .fc-timegrid-now-indicator-line { border-top-width: 3px; } /* linha “agora” mais grossa */

    /* Eventos: bloco grande, legível e contrastado */
    .fc .fc-event {
      background: var(--event-color);
      border: 0;
      border-radius: calc(12px * var(--zoom));
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
      padding: calc(2px * var(--zoom)) 0;
    }
    .fc .fc-event .fc-event-main {
      padding: calc(6px * var(--zoom)) calc(10px * var(--zoom));
      font-weight: 700;
      line-height: 1.2;
    }
    /* All-day (feriados, etc.) */
    .fc .fc-daygrid-event { 
      background: var(--event-color);
      border: 0; border-radius: calc(12px * var(--zoom));
      padding: calc(6px * var(--zoom)) calc(10px * var(--zoom));
      font-weight: 700;
    }

    /* Selo do dono da agenda */
    .who {
      position: fixed; right: 16px; top: 14px; z-index: 9999;
      background: rgba(0,0,0,.65);
      border: 1px solid var(--border);
      border-radius: calc(12px * var(--zoom));
      padding: calc(8px * var(--zoom)) calc(14px * var(--zoom));
      font: 800 calc(20px * var(--zoom))/1.1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing: .2px; color: var(--text);
      backdrop-filter: blur(3px);
    }

    /* Badge de status (debug leve) */
    .badge {
      position: fixed; left: 12px; bottom: 12px; z-index: 9999;
      background: #1f1f1f; color: #fff;
      padding: calc(6px * var(--zoom)) calc(10px * var(--zoom));
      border-radius: calc(10px * var(--zoom));
      font: 600 calc(12px * var(--zoom))/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      opacity: .85;
    }
    .badge.err { background: #9b1c1c; }
  </style>
</head>
<body>
  <div id="calendar" aria-label="Calendário do dia"></div>
  <div id="who" class="who" style="display:none"></div>
  <div id="status" class="badge">Carregando…</div>

  <script>
    // ========= Parâmetros =========
    const qs = new URLSearchParams(location.search);
    const icsUrl      = qs.get("ics");                             // obrigatório (via Worker)
    const name        = qs.get("name") || "";                      // selo
    const tz          = qs.get("tz")   || "America/Sao_Paulo";     // fuso
    const zoom        = parseFloat(qs.get("zoom") || "0") || 0;    // escala
    const color       = qs.get("color");                           // cor base (opcional)
    const initialDate = qs.get("date") || "";                      // YYYY-MM-DD (opcional)

    if (zoom > 0) document.documentElement.style.setProperty("--zoom", zoom);
    if (color) document.documentElement.style.setProperty("--event-color", color);
    if (name)  { const w = document.getElementById("who"); w.textContent = name; w.style.display = "block"; }

    const statusEl = document.getElementById("status");
    const ok  = (m)=>{ statusEl.textContent = m; statusEl.classList.remove("err"); };
    const err = (m)=>{ statusEl.textContent = m; statusEl.classList.add("err"); };

    // ========= Utilidades de data (força TZ nos timestamps) =========
    function fmtYMDHMSInTZ(epochMs, tz) {
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: tz, hour12: false,
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      }).formatToParts(new Date(epochMs)).reduce((a,p)=>(a[p.type]=p.value,a),{});
      return `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}`;
    }
    function fmtYMDInTZ(epochMs, tz) {
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: tz, year: "numeric", month: "2-digit", day: "2-digit"
      }).formatToParts(new Date(epochMs)).reduce((a,p)=>(a[p.type]=p.value,a),{});
      return `${parts.year}-${parts.month}-${parts.day}`;
    }

    async function fetchIcs(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.text();
    }

    function parseIcsToEvents(icsText, tz) {
      const jcal = ICAL.parse(icsText);
      const comp = new ICAL.Component(jcal);
      const vevents = comp.getAllSubcomponents("vevent");
      const events = vevents.map(ve => {
        const e = new ICAL.Event(ve);
        const startMs = e.startDate.toUnixTime() * 1000;
        const endMs   = e.endDate ? (e.endDate.toUnixTime() * 1000) : null;
        const title   = e.summary || "Sem título";

        if (e.startDate.isDate) { // all-day
          return { title, allDay: true, start: fmtYMDInTZ(startMs, tz), end: endMs ? fmtYMDInTZ(endMs, tz) : undefined };
        } else { // com hora
          return { title, allDay: false, start: fmtYMDHMSInTZ(startMs, tz), end: endMs ? fmtYMDHMSInTZ(endMs, tz) : undefined };
        }
      });
      return events;
    }

    function buildEventContent(arg) {
      // Layout custom: horário forte + título grande
      const time = arg.timeText;     // FullCalendar gera respeitando tz/locale
      const title = arg.event.title || "";
      const wrap = document.createElement("div");
      wrap.innerHTML =
        `<div style="font-weight:800;font-size:1.0em;opacity:.95;">${time}</div>
         <div style="font-weight:800;font-size:1.1em;line-height:1.2;margin-top:.15em;">${title}</div>`;
      return { domNodes: [wrap] };
    }

    (async function main(){
      if (!icsUrl) { err("Faltou parâmetro ?ics="); return; }

      let events = [];
      try {
        const icsText = await fetchIcs(icsUrl);
        events = parseIcsToEvents(icsText, tz);
      } catch (e) {
        console.error("Falha ao baixar/parsear ICS:", e);
        err("Falha ao baixar/parsear ICS. Veja Console (F12).");
        return;
      }

      // rolar para hora atual (aproximação)
      const now = new Date();
      const scrollHour = new Intl.DateTimeFormat("en-GB",{timeZone:tz,hour12:false,hour:"2-digit"}).format(now);

      const opts = {
        initialView: "timeGridDay",
        timeZone: tz,
        locale: "pt-br",
        height: "100%",
        expandRows: true,
        nowIndicator: true,
        allDaySlot: true,
        slotMinTime: "06:00:00",
        slotMaxTime: "22:30:00",
        scrollTime: `${scrollHour}:00:00`,
        headerToolbar: { start: "", center: "title", end: "" },
        eventTimeFormat: { hour: "2-digit", minute: "2-digit" },
        events,
        eventContent: buildEventContent
      };
      if (initialDate) opts.initialDate = initialDate;

      const cal = new FullCalendar.Calendar(document.getElementById("calendar"), opts);
      cal.render();
      ok(`${events.length} evento(s) carregado(s)`);
    })();
  </script>
</body>
</html>
